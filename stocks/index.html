<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBKR Portfólió Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { background: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; padding: 1.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div class="container mx-auto px-4 py-10">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Tőzsdei Portfólió</h1>
                <p class="text-gray-400">Bevétel és Kiadás Tracker (History alapján)</p>
            </div>
            <div id="status" class="px-3 py-1 rounded text-xs font-mono bg-yellow-900 text-yellow-200">
                CSV Betöltése...
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card border-l-4 border-blue-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Összes Befizetés</p>
                <h2 id="total-deposit" class="text-3xl font-bold mt-1 text-blue-300">$0.00</h2>
            </div>
            <div class="card border-l-4 border-green-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Összes Osztalék</p>
                <h2 id="total-dividend" class="text-3xl font-bold mt-1 text-green-400">$0.00</h2>
            </div>
            <div class="card border-l-4 border-purple-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Készpénz Egyenleg</p>
                <h2 id="cash-balance" class="text-3xl font-bold mt-1 text-purple-200">$0.00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="card">
                <h3 class="text-lg font-semibold mb-4 text-center">Havi Osztalék Bevétel</h3>
                <canvas id="dividendChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-4 text-center">Tranzakciók Aránya</h3>
                <canvas id="actionChart" height="200"></canvas>
            </div>
        </div>

        <div class="card overflow-hidden">
            <h3 class="text-lg font-semibold mb-4 text-gray-300">Tranzakciós Előzmények</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                        <tr>
                            <th class="p-3">Dátum</th>
                            <th class="p-3">Ticker</th>
                            <th class="p-3">Típus</th>
                            <th class="p-3 text-right">Összeg</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Ez a függvény intelligensen tisztítja a számokat (kezeli a dollárjelet, vesszőt, idézőjelet)
        function cleanAmount(str) {
            if (!str) return 0;
            // Eltávolítunk mindent, ami nem szám, vessző vagy pont
            let clean = str.replace(/[/"$\s\xA0]/g, '').trim();
            // Ha van benne tizedesvessző (magyar formátum), alakítsuk ponttá a számításhoz
            if (clean.includes(',')) {
                clean = clean.replace(/\./g, '').replace(',', '.');
            }
            return parseFloat(clean) || 0;
        }

        // Ez a függvény vágja szét a CSV sorait úgy, hogy az idézőjelben lévő vesszőket békén hagyja
        function splitCSVLine(line) {
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            return line.split(regex).map(c => c.replace(/"/g, '').trim());
        }

        async function loadPortfolio() {
            try {
                const response = await fetch('dev/history.csv');
                if (!response.ok) throw new Error("Fájl nem található");
                
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const dataRows = rows.slice(3); // Első 3 sor fejléc kihagyása

                let totalDeposit = 0, totalDividend = 0, cashBalance = 0;
                let monthlyDividends = {}, actionCounts = { "Buy": 0, "Deposit": 0, "Dividend": 0 };

                const tableBody = document.getElementById('transaction-table');

                dataRows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = splitCSVLine(row);
                    
                    if (cols.length < 8) return;

                    const date = cols[2];   // Dátum (YYYY.MM.DD)
                    const ticker = cols[3]; // Ticker / Cash
                    const action = cols[4]; // Buy, Deposit, Dividend
                    const amount = cleanAmount(cols[7]); // Total oszlop

                    if (action === 'Deposit') {
                        totalDeposit += amount;
                        cashBalance += amount;
                        actionCounts['Deposit']++;
                    } else if (action === 'Dividend') {
                        totalDividend += amount;
                        cashBalance += amount;
                        actionCounts['Dividend']++;
                        
                        const month = date.substring(0, 7); // Pl: "2024.10"
                        monthlyDividends[month] = (monthlyDividends[month] || 0) + amount;
                    } else if (action === 'Buy') {
                        cashBalance -= amount;
                        actionCounts['Buy']++;
                    }

                    // Sor hozzáadása a táblázathoz
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-700 hover:bg-gray-800 transition";
                    tr.innerHTML = `
                        <td class="p-3 text-gray-400">${date}</td>
                        <td class="p-3 font-bold text-blue-300">${ticker}</td>
                        <td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${action === 'Buy' ? 'bg-red-900 text-red-200' : (action === 'Deposit' ? 'bg-blue-900 text-blue-200' : 'bg-green-900 text-green-200')}">${action}</span></td>
                        <td class="p-3 text-right font-mono font-bold">$${amount.toFixed(2)}</td>
                    `;
                    tableBody.prepend(tr);
                });

                // Számok formázott kiírása
                document.getElementById('total-deposit').innerText = `$${totalDeposit.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                document.getElementById('total-dividend').innerText = `$${totalDividend.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                document.getElementById('cash-balance').innerText = `$${cashBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                
                document.getElementById('status').innerText = "Adatok Betöltve";
                document.getElementById('status').className = "px-3 py-1 rounded text-xs font-mono bg-green-900 text-green-200";

                renderCharts(monthlyDividends, actionCounts);

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "Hiba: history.csv nem található!";
                document.getElementById('status').className = "px-3 py-1 rounded text-xs font-mono bg-red-900 text-red-200";
            }
        }

        function renderCharts(dividendData, actionData) {
            // Osztalék grafikon (rendezve dátum szerint)
            const sortedMonths = Object.keys(dividendData).sort();
            const divCtx = document.getElementById('dividendChart').getContext('2d');
            new Chart(divCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Havi Osztalék ($)',
                        data: sortedMonths.map(m => dividendData[m]),
                        backgroundColor: '#10b981',
                        borderRadius: 5
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }
                }
            });

            // Kördiagram a tranzakciókról
            const actCtx = document.getElementById('actionChart').getContext('2d');
            new Chart(actCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Vétel', 'Befizetés', 'Osztalék'],
                    datasets: [{
                        data: [actionData.Buy, actionData.Deposit, actionData.Dividend],
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
            });
        }

        window.onload = loadPortfolio;
    </script>
</body>
</html>
