<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBKR Portfólió Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { background: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; padding: 1.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div class="container mx-auto px-4 py-10">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Tőzsdei Portfólió</h1>
                <p class="text-gray-400">Bevétel és Kiadás Tracker (History alapján)</p>
            </div>
            <div id="status" class="px-3 py-1 rounded text-xs font-mono bg-yellow-900 text-yellow-200">
                CSV Betöltése...
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card border-l-4 border-blue-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Összes Befizetés (Kiadás)</p>
                <h2 id="total-deposit" class="text-3xl font-bold mt-1">$0.00</h2>
            </div>
            <div class="card border-l-4 border-green-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Összes Osztalék (Bevétel)</p>
                <h2 id="total-dividend" class="text-3xl font-bold mt-1 text-green-400">$0.00</h2>
            </div>
            <div class="card border-l-4 border-purple-500">
                <p class="text-gray-400 text-xs uppercase font-semibold">Készpénz Egyenleg</p>
                <h2 id="cash-balance" class="text-3xl font-bold mt-1 text-purple-300">$0.00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Osztalék Bevétel Trend</h3>
                <canvas id="dividendChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Tranzakciók megoszlása</h3>
                <canvas id="actionChart" height="200"></canvas>
            </div>
        </div>

        <div class="card overflow-hidden">
            <h3 class="text-lg font-semibold mb-4 text-gray-300">Utolsó Tranzakciók</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs">
                        <tr>
                            <th class="p-3">Dátum</th>
                            <th class="p-3">Ticker</th>
                            <th class="p-3">Típus</th>
                            <th class="p-3 text-right">Összeg</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Szám formázása (Pl: "$1 234,56" -> 1234.56)
        function cleanAmount(str) {
            if (!str) return 0;
            // Eltávolítjuk a dollárjelet, a nem törhető szóközöket és a pontot mint ezresválasztót
            let clean = str.replace(/[$\s\xA0]/g, '').replace(/\./g, '');
            // A magyaros tizedesvesszőt pontra cseréljük
            clean = clean.replace(',', '.');
            return parseFloat(clean) || 0;
        }

        async function loadPortfolio() {
            try {
                // FONTOS: A CSV fájl neve egyezzen azzal, amit feltöltöttél
                const response = await fetch('history.csv');
                const csvText = await response.text();
                
                const rows = csvText.split('\n');
                // Az első 3 sor fejléc, így a 4. sortól indulunk (index 3)
                const dataRows = rows.slice(3);

                let totalDeposit = 0;
                let totalDividend = 0;
                let cashBalance = 0;
                let monthlyDividends = {};
                let actionCounts = { "Buy": 0, "Deposit": 0, "Dividend": 0 };

                const tableBody = document.getElementById('transaction-table');

                dataRows.forEach(row => {
                    // CSV sor felvágása (kezelve az idézőjeleket)
                    const cols = row.split(',').map(c => c.replace(/"/g, '').trim());
                    
                    if (cols.length < 8) return;

                    const date = cols[2];   // Dátum oszlop
                    const ticker = cols[3]; // Ticker oszlop
                    const action = cols[4]; // Action oszlop
                    const amount = cleanAmount(cols[7]); // Total oszlop

                    // Számítások
                    if (action === 'Deposit') {
                        totalDeposit += amount;
                        cashBalance += amount;
                        actionCounts['Deposit']++;
                    } else if (action === 'Dividend') {
                        totalDividend += amount;
                        cashBalance += amount;
                        actionCounts['Dividend']++;
                        
                        // Havi bontás a grafikonhoz (YYYY.MM formátum)
                        const month = date.substring(0, 7);
                        monthlyDividends[month] = (monthlyDividends[month] || 0) + amount;
                    } else if (action === 'Buy') {
                        cashBalance -= amount; // Vásárlásnál csökken a készpénz
                        actionCounts['Buy']++;
                    }

                    // Táblázat építése (csak az utolsó 10 sort adjuk hozzá a példa kedvéért)
                    if (date) {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-700 hover:bg-gray-800";
                        tr.innerHTML = `
                            <td class="p-3 text-gray-400">${date}</td>
                            <td class="p-3 font-bold">${ticker}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-[10px] ${action === 'Buy' ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}">${action}</span></td>
                            <td class="p-3 text-right font-mono">$${amount.toFixed(2)}</td>
                        `;
                        tableBody.prepend(tr);
                    }
                });

                // UI Frissítése
                document.getElementById('total-deposit').innerText = `$${totalDeposit.toLocaleString('hu-HU')}`;
                document.getElementById('total-dividend').innerText = `$${totalDividend.toLocaleString('hu-HU')}`;
                document.getElementById('cash-balance').innerText = `$${cashBalance.toLocaleString('hu-HU')}`;
                document.getElementById('status').innerText = "Adatok Frissítve";
                document.getElementById('status').className = "px-3 py-1 rounded text-xs font-mono bg-green-900 text-green-200";

                renderCharts(monthlyDividends, actionCounts);

            } catch (error) {
                console.error("Hiba történt:", error);
                document.getElementById('status').innerText = "Hiba a betöltéskor!";
                document.getElementById('status').className = "px-3 py-1 rounded text-xs font-mono bg-red-900 text-red-200";
            }
        }

        function renderCharts(dividendData, actionData) {
            // Osztalék trend grafikon
            const divCtx = document.getElementById('dividendChart').getContext('2d');
            new Chart(divCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(dividendData),
                    datasets: [{
                        label: 'Havi Osztalék ($)',
                        data: Object.values(dividendData),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { y: { grid: { color: '#374151' } }, x: { grid: { display: false } } }
                }
            });

            // Akciók megoszlása grafikon
            const actCtx = document.getElementById('actionChart').getContext('2d');
            new Chart(actCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Vétel', 'Befizetés', 'Osztalék'],
                    datasets: [{
                        data: [actionData.Buy, actionData.Deposit, actionData.Dividend],
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
            });
        }

        window.onload = loadPortfolio;
    </script>
</body>
</html>
